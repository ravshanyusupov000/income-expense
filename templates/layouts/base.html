{% load static %}
{% load i18n %}
<!doctype html>
<html lang="uz">
<head>
  {%csrf_token%}
  <meta name="csrf-token" content="{{ csrf_token }}">
  <meta charset="utf-8" />
  <meta name="csrf-token" content="{{ csrf_token }}">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}{% trans "Dashboard" %}{% endblock %}</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{% static 'css/app.css' %}" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="d-flex">
    <!-- SIDEBAR -->
    <aside class="sidebar bg-white border-end">
      <div class="p-3 fw-bold fs-5">{% trans "Income-Expense" %}</div>
      <nav class="nav flex-column px-2">
        <a class="nav-link active" href="{% url 'finance:dashboard' %}">{% trans "Dashboard" %}</a>
        <a class="nav-link" href="{% url 'finance:tx_list' %}">{% trans "Transactions" %}</a>
        <a class="nav-link" href="{% url 'finance:tx_add' %}">{% trans "Add" %}</a>
        <a class="nav-link" href="{% url 'finance:report' %}">{% trans "Report" %}</a>
        <a class="nav-link" href="{% url 'finance:account_list' %}">{% trans "Accounts" %}</a>
        <a class="nav-link" href="{% url 'finance:category_list' %}">{% trans "Categories" %}</a>
      </nav>
      <div class="mt-auto p-3 small text-muted">v1.0</div>
    </aside>

    <!-- MAIN -->
    <main class="flex-grow-1">
      <!-- TOPBAR -->
      <header class="topbar bg-white border-bottom px-3 py-2 d-flex align-items-center gap-2">
        <form class="ms-auto d-flex" method="get" action="{% url 'finance:tx_list' %}">
          <input class="form-control form-control-sm me-2" name="q" placeholder="{% trans 'Search...' %}" />
          <button class="btn btn-sm btn-primary">{% trans "Search" %}</button>
        </form>
        <form action="{% url 'set_language' %}" method="post" class="ms-2">
          {% csrf_token %}
          <input name="next" type="hidden" value="{{ request.get_full_path }}">
          <select name="language" class="form-select form-select-sm" onchange="this.form.submit()">
            {% get_current_language as LANGUAGE_CODE %}
            {% get_available_languages as LANGUAGES %}
            {% for lang in LANGUAGES %}
              <option value="{{ lang.0 }}" {% if lang.0 == LANGUAGE_CODE %}selected{% endif %}>
                {{ lang.1 }}
              </option>
            {% endfor %}
          </select>
        </form>
        <form method="post" action="{% url 'logout' %}" class="ms-2">
          {% csrf_token %}
          <button class="btn btn-sm btn-outline-secondary">{% trans "logout" %}</button>
        </form>
      </header>

      <div class="p-3 p-md-4">
        {% block content %}{% endblock %}
      </div>
    </main>
  </div>

  <script>window.APP_LANG = "{{ request.LANGUAGE_CODE|slice:':2' }}";</script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{% static 'js/app.js' %}"></script>
    {% load i18n %}
  <style>
  .support-fab{
    position: fixed;
    right: 18px;
    bottom: 18px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    border: none;
    background: #111827;
    color: #fff;
    z-index: 9999;
    box-shadow: 0 10px 25px rgba(0,0,0,.25);
  }
  .support-fab:hover{ transform: translateY(-1px); }
  </style>
  <button class="btn btn-dark support-fab"
          type="button"
          data-bs-toggle="offcanvas"
          data-bs-target="#supportCanvas"
          aria-controls="supportCanvas"
          title="{% trans 'Support' %}">
    <span style="font-size:20px; line-height:1">ðŸ’¬</span>
  </button>

  <div class="offcanvas offcanvas-end" tabindex="-1" id="supportCanvas" aria-labelledby="supportCanvasLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="supportCanvasLabel">{% trans "Support" %}</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>

    <div class="offcanvas-body">
      {% if request.user.is_authenticated %}
        <div id="supportAlert" class="alert d-none" role="alert"></div>

        <form id="supportForm">
          {% csrf_token %}
          <div class="mb-2">
            <label class="form-label">{% trans "Subject" %}</label>
            <input class="form-control" name="subject" maxlength="150" required>
          </div>

          <div class="mb-2">
            <label class="form-label">{% trans "Message" %}</label>
            <textarea class="form-control" name="message" rows="3" required></textarea>
          </div>

          <div class="mb-2">
            <label class="form-label">{% trans "Phone number" %}</label>
            <input
              class="form-control"
              name="phone"
              type="tel"
              inputmode="numeric"
              maxlength="13"
              required
              placeholder="+998901234567"
            >
            <div class="text-danger small d-none" id="phoneError">
              {% trans "Enter phone number in +998XXXXXXXXX format" %}
            </div>
          </div>


          <button id="support-send" class="btn btn-primary">
            {% trans "Send" %}
          </button>


          <div class="text-muted small mt-2">
            {% trans "We typically reply within 24 hours." %}
          </div>
        </form>
      {% else %}
        <div class="alert alert-warning">
          {% trans "Please log in to contact support." %}
        </div>
        <a class="btn btn-primary w-100" href="{% url 'login' %}">
          {% trans "Login" %}
        </a>
      {% endif %}
    </div>
  </div>

  <script>
    (function(){
      const form = document.getElementById("supportForm");
      if(!form) return;

      const alertBox = document.getElementById("supportAlert");

      function showAlert(type, text){
        alertBox.className = "alert alert-" + type;
        alertBox.textContent = text;
        alertBox.classList.remove("d-none");
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const formData = new FormData(form);

        try{
          const res = await fetch("{% url 'finance:support_quick' %}", {
            method: "POST",
            headers: { "X-Requested-With": "XMLHttpRequest" },
            body: formData
          });

          const data = await res.json();
          if(!res.ok){
            showAlert("danger", data.error || "Error");
            return;
          }

          showAlert("success", data.message || "OK");
          form.reset();
        }catch(err){
          showAlert("danger", "Network error");
        }
      });
    })();
  </script>
  {% csrf_token %}
  {% block scripts %}{% endblock %}
</body>
</html>
